---
phase: 02-content-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - keystatic.config.ts
  - src/lib/locations.ts
  - content/locations/dabrowa.mdoc
  - .env.example
autonomous: true
requirements: [CMS-01, CMS-04, CMS-05]

must_haves:
  truths:
    - "Keystatic admin shows an images array field (multiple images) on each location entry"
    - "Each location entry has city, country, and date text fields"
    - "Keystatic is configured for GitHub storage mode (not local)"
    - "The existing dabrowa entry has all new fields present (may be empty)"
    - "getLocations() returns images[], city, country, date on each LocationListItem"
    - ".env.example documents KEYSTATIC_GITHUB_CLIENT_ID, KEYSTATIC_GITHUB_CLIENT_SECRET, and KEYSTATIC_SECRET with instructions"
  artifacts:
    - path: "keystatic.config.ts"
      provides: "Updated collection schema with images array, city, country, date + github storage"
      contains: "github"
    - path: "src/lib/locations.ts"
      provides: "Updated server function returning extended LocationListItem type"
      contains: "images"
    - path: "content/locations/dabrowa.mdoc"
      provides: "Migrated existing entry with new fields"
    - path: ".env.example"
      provides: "Documented GitHub OAuth env vars for Keystatic"
      contains: "KEYSTATIC_GITHUB_CLIENT_ID"
  key_links:
    - from: "keystatic.config.ts"
      to: "src/lib/locations.ts"
      via: "Keystatic reader uses config schema to type entries"
      pattern: "images"
    - from: "src/lib/locations.ts"
      to: "content/locations/dabrowa.mdoc"
      via: "createServerFn reads content directory entries"
      pattern: "getLocations"
---

<objective>
Extend the Keystatic `locations` collection schema to support multiple images per entry, add city/country/date fields, and switch storage to GitHub mode. Update the `getLocations` server function to return the new fields. Create `.env.example` documenting the GitHub OAuth credentials required for Keystatic to work on Vercel.

Purpose: This is the foundation for CMS-managed location pages (Plan 04). Without the schema, the image carousel and dedicated pages cannot be built. The .env.example ensures CMS-05 is satisfied — the credentials are documented and ready for the Vercel dashboard wiring that happens in Phase 3.
Output: Updated keystatic.config.ts, updated src/lib/locations.ts, updated content/locations/dabrowa.mdoc, new .env.example.
</objective>

<execution_context>
@/home/lucas/.claude/get-shit-done/workflows/execute-plan.md
@/home/lucas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@keystatic.config.ts
@src/lib/locations.ts
@content/locations/dabrowa.mdoc
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Keystatic schema — images array, city, country, date, GitHub storage</name>
  <files>keystatic.config.ts</files>
  <action>
    Update keystatic.config.ts with these changes:

    1. **Storage mode** — change `storage: { kind: 'local' }` to GitHub mode:
       ```ts
       storage: {
         kind: 'github',
         repo: {
           owner: process.env.KEYSTATIC_GITHUB_REPO_OWNER ?? 'OWNER',
           name: process.env.KEYSTATIC_GITHUB_REPO_NAME ?? 'REPO',
         },
       },
       ```
       The OWNER/REPO fallbacks are placeholders — real values will come from env vars set in Vercel (Phase 3). This satisfies CMS-04 at config level; env vars are a user_setup item for Phase 3.

    2. **Schema fields** — keep all existing fields (name, coordinates, summary, content, coverImage) and ADD:
       - `city`: `fields.text({ label: 'City' })` — text field for city name
       - `country`: `fields.text({ label: 'Country' })` — text field for country name
       - `date`: `fields.text({ label: 'Date / Period' })` — text field (e.g. "15 grudnia 2023")
       - `images`: `fields.array(fields.image({ label: 'Image', directory: 'public/images/locations' }), { label: 'Images', itemLabel: props => props.fields.discriminant?.value ?? 'Image' })`
         NOTE: Use `fields.array` wrapping `fields.image`. Check the installed @keystatic/core version (0.5.48) API. The correct pattern for an array of images in Keystatic 0.5.x is:
         ```ts
         images: fields.array(
           fields.image({
             label: 'Image',
             directory: 'public/images/locations',
             publicPath: '/images/locations/',
           }),
           { label: 'Images' }
         ),
         ```
         If `fields.array` does not accept `fields.image` directly (type error), use `fields.array(fields.text({ label: 'Image path' }), { label: 'Images' })` as a fallback — document this in the summary. The array stores paths, not embedded image objects.

    3. Remove the singular `coverImage` field since `images` array replaces it. This avoids dual-field confusion.

    Import statements: keep existing `collection, config, fields` imports from `@keystatic/core`.
  </action>
  <verify>Run `pnpm tsc --noEmit` — no new TypeScript errors from keystatic.config.ts changes. Also run `pnpm dev` briefly and confirm `/keystatic` admin loads (Keystatic validates config at runtime).</verify>
  <done>keystatic.config.ts has github storage mode, images array field, city/country/date text fields, and no coverImage field. TypeScript compiles clean.</done>
</task>

<task type="auto">
  <name>Task 2: Update LocationListItem type and getLocations server function</name>
  <files>src/lib/locations.ts, content/locations/dabrowa.mdoc</files>
  <action>
    **src/lib/locations.ts:**

    Update `LocationListItem` type to remove `coverImage` and add:
    ```ts
    export type LocationListItem = {
      images: string[]      // array of image paths (may be empty)
      city: string
      country: string
      date: string
      coordinates: { lat: number; lng: number }
      name: string
      slug: string
      summary: string
    }
    ```

    In the `getLocations` handler, update the `entry` type cast to include the new fields:
    ```ts
    const entry = item.entry as {
      coordinates?: { lat?: number; lng?: number }
      images?: unknown[]
      city?: unknown
      country?: unknown
      date?: unknown
      name?: unknown
      summary?: unknown
    }
    ```

    Normalize `images`: the Keystatic image array field returns objects with `{ src?: string }` or plain strings. Use the existing `normalizeImage` helper on each element:
    ```ts
    const rawImages = Array.isArray(entry.images) ? entry.images : []
    const images = rawImages.map(img => normalizeImage(img)).filter((s): s is string => s !== null)
    ```

    Return the updated shape satisfying the new `LocationListItem` type. Remove `coverImage` from the return.

    Keep all existing helper functions (`pickString`, `normalizeLocationName`, `normalizeImage`) — they are still used.

    **content/locations/dabrowa.mdoc:**

    Update the frontmatter to remove `coverImage` and add the new fields (empty values are fine):
    ```yaml
    ---
    name: Dabrowa
    coordinates:
      lat: 54.493
      lng: 18.467
    summary: Dabrowa test 123.
    city: Dąbrowa
    country: Polska
    date: ''
    images: []
    ---
    Opis i content.
    ```
  </action>
  <verify>Run `pnpm tsc --noEmit` — no TypeScript errors. In the running dev server, open browser console on `/` and confirm the network call to `getLocations` returns objects with `images`, `city`, `country`, `date` fields (check Network tab or add a console.log temporarily).</verify>
  <done>LocationListItem type has images[], city, country, date. getLocations() returns the new shape. dabrowa.mdoc has the new fields. No TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 3: Create .env.example documenting Keystatic GitHub OAuth credentials</name>
  <files>.env.example</files>
  <action>
    Create `.env.example` at the project root (next to `package.json`). This file documents all environment variables needed for Keystatic to work in GitHub storage mode on Vercel. It satisfies CMS-05 — the credentials are specified so the deployer knows exactly what to set.

    Content:
    ```
    # Keystatic CMS — GitHub OAuth App credentials
    # Create an OAuth App at: https://github.com/settings/developers
    # Homepage URL: https://your-vercel-domain.vercel.app
    # Authorization callback URL: https://your-vercel-domain.vercel.app/api/keystatic/github/oauth/callback
    KEYSTATIC_GITHUB_CLIENT_ID=your_github_oauth_app_client_id
    KEYSTATIC_GITHUB_CLIENT_SECRET=your_github_oauth_app_client_secret

    # Keystatic secret — random string used to sign session tokens
    # Generate with: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
    KEYSTATIC_SECRET=your_random_secret_string

    # GitHub repository for Keystatic content storage
    # These tell Keystatic which repo to commit content changes to
    KEYSTATIC_GITHUB_REPO_OWNER=your_github_username_or_org
    KEYSTATIC_GITHUB_REPO_NAME=your_repository_name
    ```

    If a `.env.example` already exists, append the Keystatic block rather than overwriting — check first with `cat .env.example`.

    Note: `.env.example` is committed to git (no real secrets, only placeholders). The actual `.env` or `.env.local` file with real values must NOT be committed — confirm `.gitignore` already excludes `.env` and `.env.local` (standard practice; do not modify .gitignore unless those patterns are missing).
  </action>
  <verify>Run `cat .env.example` and confirm all 5 variable names are present: KEYSTATIC_GITHUB_CLIENT_ID, KEYSTATIC_GITHUB_CLIENT_SECRET, KEYSTATIC_SECRET, KEYSTATIC_GITHUB_REPO_OWNER, KEYSTATIC_GITHUB_REPO_NAME. Confirm `.env.example` is NOT in `.gitignore`.</verify>
  <done>.env.example exists with all 5 Keystatic env var names, instructions for where to get each value, and setup URL for GitHub OAuth App creation.</done>
</task>

</tasks>

<verification>
- `pnpm tsc --noEmit` passes with no new errors
- `keystatic.config.ts` contains `kind: 'github'`, `fields.array`, `city`, `country`, `date`
- `src/lib/locations.ts` LocationListItem has `images: string[]`, `city`, `country`, `date`; no `coverImage`
- `content/locations/dabrowa.mdoc` frontmatter has `city`, `country`, `date`, `images` keys
- Keystatic admin at `/keystatic` loads without crashing
- `.env.example` contains KEYSTATIC_GITHUB_CLIENT_ID, KEYSTATIC_GITHUB_CLIENT_SECRET, KEYSTATIC_SECRET, KEYSTATIC_GITHUB_REPO_OWNER, KEYSTATIC_GITHUB_REPO_NAME with setup instructions
</verification>

<success_criteria>
The Keystatic locations collection schema has been extended with images array + city/country/date, storage mode is GitHub, and the server function reflects the new types. The existing dabrowa entry is migrated. .env.example documents the GitHub OAuth credentials required for Vercel deployment. This unblocks Plan 04 (location pages) and satisfies CMS-01, CMS-04, and CMS-05.
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-polish/02-01-SUMMARY.md`
</output>
