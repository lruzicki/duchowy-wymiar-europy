---
phase: 02-content-polish
plan: 04
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/components/figma/ProjectsMap.tsx
  - src/routes/locations.$slug.tsx
  - src/lib/locations.ts
  - src/locales/pl.json
  - src/locales/en.json
  - src/locales/de.json
  - src/locales/uk.json
  - src/locales/ru.json
  - src/locales/ar.json
  - src/routeTree.gen.ts
autonomous: true
requirements: [CMS-02, CMS-03, BRAND-02]
# depends_on includes both 02-01 and 02-02 because all three plans write to all 6 locale files.
# 02-01 and 02-02 run in parallel (wave 1). 02-04 runs after both complete (wave 2) to
# avoid locale file conflicts.
# routeTree.gen.ts is auto-regenerated by the TanStack Router plugin when
# locations.$slug.tsx is created; it is listed here for file-ownership tracking.

must_haves:
  truths:
    - "Clicking a map pin opens a small Leaflet popup with location name, city/country, and a 'See more' link"
    - "Clicking 'See more' navigates to /locations/[slug] page"
    - "The location page shows an image carousel with prev/next navigation"
    - "The location page shows the full description, date, city and country"
    - "A 'Back to map' link on the location page returns to the home page map section"
    - "No hardcoded projectsData array exists in ProjectsMap.tsx — all data comes from Keystatic via getLocations()"
    - "No Unsplash image URLs appear anywhere in source files"
    - "All UI strings on the location page (back link, empty state, not-found) are translated via t() and exist in all 6 locale files"
  artifacts:
    - path: "src/components/figma/ProjectsMap.tsx"
      provides: "Refactored map using CMS data exclusively, minimal popup with link"
      contains: "locations/"
    - path: "src/routes/locations.$slug.tsx"
      provides: "Location detail page with image carousel, description, back link"
      min_lines: 80
    - path: "src/lib/locations.ts"
      provides: "getLocationBySlug server function for individual location lookup"
      contains: "getLocationBySlug"
  key_links:
    - from: "src/components/figma/ProjectsMap.tsx"
      to: "src/routes/locations.$slug.tsx"
      via: "Leaflet popup 'See more' link href=/locations/[slug]"
      pattern: "/locations/"
    - from: "src/routes/locations.$slug.tsx"
      to: "src/lib/locations.ts"
      via: "route loader calls getLocationBySlug(slug)"
      pattern: "getLocationBySlug"
    - from: "src/lib/locations.ts"
      to: "keystatic.config.ts"
      via: "Keystatic reader uses config schema"
      pattern: "reader.collections.locations"
    - from: "src/routes/locations.$slug.tsx"
      to: "src/routeTree.gen.ts"
      via: "TanStack Router plugin auto-generates route tree on dev server start"
      pattern: "locations/\\$slug"
---

<objective>
Replace the hardcoded projectsData array with CMS-driven data, refactor the map pin popup to be a minimal preview with a "See more" link, and create dedicated `/locations/[slug]` pages with image carousels.

Purpose: Completes CMS-02 (carousel on location pages), CMS-03 (remove hardcoded data), BRAND-02 (remove Unsplash URLs). This is the core content migration task for Phase 2.
Output: Refactored ProjectsMap.tsx, new locations.$slug.tsx route, updated locations.ts with getLocationBySlug, updated locale files with map.seeMore, map.noLocations, location.backToMap, location.noImages, and location.notFound keys.
</objective>

<execution_context>
@/home/lucas/.claude/get-shit-done/workflows/execute-plan.md
@/home/lucas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/figma/ProjectsMap.tsx
@src/lib/locations.ts
@src/routes/index.tsx
@.planning/phases/02-content-polish/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getLocationBySlug server function and refactor ProjectsMap to use CMS data only</name>
  <files>src/lib/locations.ts, src/components/figma/ProjectsMap.tsx</files>
  <action>
    **src/lib/locations.ts:**

    Add a second server function `getLocationBySlug` for individual location detail pages:

    ```ts
    export const getLocationBySlug = createServerFn({ method: 'GET' })
      .validator((slug: string) => slug)
      .handler(async ({ data: slug }) => {
        const [{ createReader }, { default: keystaticConfig }] = await Promise.all([
          import('@keystatic/core/reader'),
          import('../../keystatic.config'),
        ])
        const reader = createReader(process.cwd(), keystaticConfig)
        const entry = await reader.collections.locations.read(slug)
        if (!entry) return null

        const typedEntry = entry as {
          coordinates?: { lat?: number; lng?: number }
          images?: unknown[]
          city?: unknown
          country?: unknown
          date?: unknown
          name?: unknown
          summary?: unknown
        }

        const lat = typedEntry.coordinates?.lat
        const lng = typedEntry.coordinates?.lng
        if (typeof lat !== 'number' || typeof lng !== 'number') return null

        const rawImages = Array.isArray(typedEntry.images) ? typedEntry.images : []
        const images = rawImages.map(img => normalizeImage(img)).filter((s): s is string => s !== null)

        return {
          images,
          city: pickString(typedEntry.city),
          country: pickString(typedEntry.country),
          date: pickString(typedEntry.date),
          coordinates: { lat, lng },
          name: normalizeLocationName(typedEntry.name, slug),
          slug,
          summary: pickString(typedEntry.summary),
        } satisfies LocationListItem
      })
    ```

    Export both `getLocations` and `getLocationBySlug`.

    **src/components/figma/ProjectsMap.tsx:**

    This is a significant refactor. Remove the hardcoded `projectsData` array (including all Unsplash URLs). Remove the `Project` interface. The component will ONLY use CMS data from the `locations` prop.

    Update the component to use `LocationListItem[]` directly:

    ```tsx
    interface ProjectsMapProps {
      locations?: LocationListItem[]
    }

    export function ProjectsMap({ locations = [] }: ProjectsMapProps) {
      const { t } = useTranslation()
      const mapRef = useRef<HTMLDivElement>(null)
      const mapInstanceRef = useRef<any>(null)
      const markersRef = useRef<any[]>([])
      const [selectedSlug, setSelectedSlug] = useState<string | null>(null)
      const [mapLoaded, setMapLoaded] = useState(false)
    ```

    Map markers should now create a minimal Leaflet popup (NOT the full dialog) with:
    - Location name
    - City + Country (if available)
    - A plain HTML anchor linking to the detail page, using t('map.seeMore') for the link text

    Update marker click handler to call `marker.openPopup()`:
    ```ts
    locations.forEach((location) => {
      const marker = L.marker([location.coordinates.lat, location.coordinates.lng]).addTo(map)

      const popupContent = `
        <div style="min-width: 180px; padding: 4px;">
          <h3 style="margin: 0 0 4px 0; font-size: 15px; font-weight: 600;">${location.name}</h3>
          ${location.city || location.country ? `<p style="margin: 0 0 8px 0; font-size: 13px; color: #666;">${[location.city, location.country].filter(Boolean).join(', ')}</p>` : ''}
          <a href="/locations/${location.slug}" style="display:inline-block;margin-top:4px;color:#0066cc;font-weight:600;font-size:13px;text-decoration:none;">→ ${t('map.seeMore')}</a>
        </div>
      `
      marker.bindPopup(popupContent)
      markers.push(marker)
    })
    ```

    Keep the project list sidebar, but simplify it to show CMS location cards. Clicking a sidebar card navigates to the detail page (per user decision: "Popup links to a dedicated location page"):
    ```tsx
    {locations.map((location) => (
      <Card
        key={location.slug}
        className="cursor-pointer transition-all hover:shadow-lg hover:scale-[1.02] hover:border-primary/50"
        onClick={() => { window.location.href = `/locations/${location.slug}` }}
      >
        <CardHeader className="p-4 pb-3">
          <CardTitle className="text-base flex items-start gap-2 leading-tight">
            <MapPin className="w-4 h-4 text-primary shrink-0 mt-1" />
            <span className="line-clamp-2">{location.name}</span>
          </CardTitle>
          {(location.city || location.country) && (
            <CardDescription className="text-sm mt-1">
              {[location.city, location.country].filter(Boolean).join(', ')}
            </CardDescription>
          )}
        </CardHeader>
        {location.date && (
          <CardContent className="p-4 pt-0">
            <div className="flex items-center gap-1 text-xs text-muted-foreground">
              <Calendar className="w-3 h-3" />
              {location.date}
            </div>
          </CardContent>
        )}
      </Card>
    ))}
    ```

    If `locations.length === 0`, show a centered empty-state message using `t('map.noLocations')`.

    Remove the `<Dialog>` component entirely (it was the old project detail dialog). Remove all dialog-related state (`selectedProject`, `currentImageIndex`) and handlers (`nextImage`, `prevImage`, `handleProjectSelect`).

    Remove unused imports: `ChevronLeft`, `ChevronRight`, `Dialog`, `DialogContent`, `DialogHeader`, `DialogTitle`, `Users` (if no longer used). Keep `MapPin`, `Calendar`, `Card`, `CardContent`, `CardHeader`, `CardTitle`, `CardDescription`, `Button`, `ScrollArea`, `Badge`.
  </action>
  <verify>Run `pnpm tsc --noEmit`. Grep for "unsplash" in src/components/figma/ProjectsMap.tsx — must return zero results. Grep for "projectsData" in src/components/figma/ProjectsMap.tsx — must return zero results. Start dev server and confirm map loads with CMS data (dabrowa pin visible), popup shows name + "See more" link.</verify>
  <done>ProjectsMap.tsx has no hardcoded projectsData array, no Unsplash URLs, no Dialog component. getLocationBySlug is exported from locations.ts. Map shows CMS pins with minimal popup linking to /locations/[slug]. Sidebar cards navigate to location pages. TypeScript compiles clean.</done>
</task>

<task type="auto">
  <name>Task 2: Create /locations/[slug] route with image carousel</name>
  <files>src/routes/locations.$slug.tsx</files>
  <action>
    Create `src/routes/locations.$slug.tsx` — a TanStack Router file-based route for `/locations/[slug]`.

    TanStack Router dynamic route pattern: file named `locations.$slug.tsx` creates route `/locations/:slug`.

    All UI strings MUST use `t()` — no hardcoded Polish strings. The keys location.backToMap, location.noImages, and location.notFound will be added to all locale files in Task 3.

    ```tsx
    import { createFileRoute, Link } from '@tanstack/react-router'
    import { useState } from 'react'
    import { useTranslation } from 'react-i18next'
    import { ChevronLeft, ChevronRight, ArrowLeft, MapPin, Calendar } from 'lucide-react'
    import { Button } from '@/components/ui/button'
    import { Badge } from '@/components/ui/badge'
    import { getLocationBySlug } from '@/lib/locations'

    export const Route = createFileRoute('/locations/$slug')({
      loader: async ({ params }) => {
        const location = await getLocationBySlug({ data: params.slug })
        if (!location) throw new Error('Location not found')
        return location
      },
      component: LocationPage,
      errorComponent: LocationNotFound,
    })

    function LocationPage() {
      const location = Route.useLoaderData()
      const { t } = useTranslation()
      const [currentImageIndex, setCurrentImageIndex] = useState(0)

      const nextImage = () => {
        setCurrentImageIndex(prev =>
          prev === location.images.length - 1 ? 0 : prev + 1
        )
      }
      const prevImage = () => {
        setCurrentImageIndex(prev =>
          prev === 0 ? location.images.length - 1 : prev - 1
        )
      }

      return (
        <div className="min-h-screen bg-slate-50">
          {/* Back link */}
          <div className="max-w-4xl mx-auto px-4 pt-8 pb-4">
            <Link to="/" hash="projekty">
              <Button variant="ghost" className="gap-2 text-muted-foreground hover:text-foreground">
                <ArrowLeft className="w-4 h-4" />
                {t('location.backToMap')}
              </Button>
            </Link>
          </div>

          <div className="max-w-4xl mx-auto px-4 pb-16">
            {/* Image carousel */}
            {location.images.length > 0 ? (
              <div className="relative aspect-video bg-slate-200 rounded-2xl overflow-hidden mb-8 shadow-lg">
                <img
                  src={location.images[currentImageIndex]}
                  alt={location.name}
                  className="w-full h-full object-cover"
                />
                {location.images.length > 1 && (
                  <>
                    <Button
                      variant="secondary"
                      size="icon"
                      className="absolute left-3 top-1/2 -translate-y-1/2 opacity-80 hover:opacity-100"
                      onClick={prevImage}
                    >
                      <ChevronLeft className="w-4 h-4" />
                    </Button>
                    <Button
                      variant="secondary"
                      size="icon"
                      className="absolute right-3 top-1/2 -translate-y-1/2 opacity-80 hover:opacity-100"
                      onClick={nextImage}
                    >
                      <ChevronRight className="w-4 h-4" />
                    </Button>
                    <div className="absolute bottom-3 left-1/2 -translate-x-1/2 px-3 py-1 bg-black/50 text-white text-xs rounded-full">
                      {currentImageIndex + 1} / {location.images.length}
                    </div>
                  </>
                )}
              </div>
            ) : (
              <div className="aspect-video bg-slate-200 rounded-2xl mb-8 flex items-center justify-center">
                <p className="text-muted-foreground text-sm">{t('location.noImages')}</p>
              </div>
            )}

            {/* Location info */}
            <h1 className="text-3xl font-semibold text-slate-900 mb-4">{location.name}</h1>

            <div className="flex flex-wrap gap-3 mb-6">
              {(location.city || location.country) && (
                <Badge variant="secondary" className="gap-1">
                  <MapPin className="w-3 h-3" />
                  {[location.city, location.country].filter(Boolean).join(', ')}
                </Badge>
              )}
              {location.date && (
                <Badge variant="outline" className="gap-1">
                  <Calendar className="w-3 h-3" />
                  {location.date}
                </Badge>
              )}
            </div>

            {location.summary && (
              <p className="text-base leading-relaxed text-slate-700 max-w-2xl">
                {location.summary}
              </p>
            )}
          </div>
        </div>
      )
    }

    function LocationNotFound() {
      const { t } = useTranslation()
      return (
        <div className="min-h-screen flex items-center justify-center">
          <div className="text-center">
            <h1 className="text-2xl font-semibold mb-4">{t('location.notFound')}</h1>
            <Link to="/">
              <Button>{t('location.backToMap')}</Button>
            </Link>
          </div>
        </div>
      )
    }
    ```

    Note on `Link to="/" hash="projekty"`: TanStack Router's `<Link>` component supports `hash` prop to navigate to an anchor. Use `<Link to="/" hash="projekty">` to scroll to the map section.

    After creating this file, start (or restart) the dev server so TanStack Router's file-based route plugin regenerates `src/routeTree.gen.ts`. Verify the new route appears in routeTree.gen.ts by running: `grep -n "locations" src/routeTree.gen.ts` — the output must include a line referencing `locations/$slug` or similar.

    Image paths from Keystatic: Keystatic stores images relative to the `directory` configured in the schema (e.g., `public/images/locations`). The `normalizeImage` function in locations.ts extracts the filename. Image paths served statically from `/public` are accessible at `/images/locations/filename.jpg`. Ensure the image src resolves correctly — if Keystatic returns a full path like `public/images/locations/file.jpg`, strip the `public/` prefix for the `src` attribute. Add path normalization in the `getLocationBySlug` handler if needed:
    ```ts
    const images = rawImages
      .map(img => normalizeImage(img))
      .filter((s): s is string => s !== null)
      .map(path => path.startsWith('public/') ? path.slice(7) : path)
    ```
    Apply the same normalization in `getLocations` for consistency.
  </action>
  <verify>Run `pnpm tsc --noEmit`. Run `grep -n "Powrót\|Brak zdjęć\|Lokalizacja nie" src/routes/locations.\$slug.tsx` — must return zero results (all strings must be in t() calls). Start dev server. Navigate to http://localhost:3000/locations/dabrowa — page must load (even if images are empty, the layout should render). Back-to-map button should be visible. No console errors. Run `grep -n "locations" src/routeTree.gen.ts` — must include the new route entry.</verify>
  <done>Route /locations/dabrowa loads with location name, city/country badges, date badge, image area (empty or populated), and back-to-map button. All UI strings use t(). routeTree.gen.ts contains the locations/$slug route entry. TypeScript compiles clean.</done>
</task>

<task type="auto">
  <name>Task 3: Add map and location i18n keys to all 6 locale files</name>
  <files>src/locales/pl.json, src/locales/en.json, src/locales/de.json, src/locales/uk.json, src/locales/ru.json, src/locales/ar.json</files>
  <action>
    Add the following keys to ALL 6 locale files. Polish is canonical; translate appropriately for each language.

    **New keys to add:**

    ```json
    "map.seeMore": "Zobacz więcej",
    "map.noLocations": "Brak lokalizacji w bazie",
    "location.backToMap": "Powrót do mapy",
    "location.noImages": "Brak zdjęć",
    "location.notFound": "Lokalizacja nie znaleziona"
    ```

    **Translations by language:**

    English (en.json):
    - map.seeMore: "See more"
    - map.noLocations: "No locations in database"
    - location.backToMap: "Back to map"
    - location.noImages: "No images available"
    - location.notFound: "Location not found"

    German (de.json):
    - map.seeMore: "Mehr sehen"
    - map.noLocations: "Keine Standorte in der Datenbank"
    - location.backToMap: "Zurück zur Karte"
    - location.noImages: "Keine Bilder vorhanden"
    - location.notFound: "Standort nicht gefunden"

    Ukrainian (uk.json):
    - map.seeMore: "Дивитися більше"
    - map.noLocations: "Немає локацій у базі"
    - location.backToMap: "Повернутися до карти"
    - location.noImages: "Зображень немає"
    - location.notFound: "Локацію не знайдено"

    Russian (ru.json):
    - map.seeMore: "Подробнее"
    - map.noLocations: "Нет локаций в базе"
    - location.backToMap: "Вернуться к карте"
    - location.noImages: "Изображений нет"
    - location.notFound: "Локация не найдена"

    Arabic (ar.json):
    - map.seeMore: "عرض المزيد"
    - map.noLocations: "لا توجد مواقع في قاعدة البيانات"
    - location.backToMap: "العودة إلى الخريطة"
    - location.noImages: "لا تتوفر صور"
    - location.notFound: "الموقع غير موجود"

    Keep all existing keys — only append. Maintain valid JSON (no trailing commas on last key).

    IMPORTANT: Plans 02-01 and 02-02 may have already added keys to these files. Read each file before editing to confirm the exact current state and avoid duplicate keys or invalid JSON.
  </action>
  <verify>Run `node -e "JSON.parse(require('fs').readFileSync('src/locales/pl.json','utf8'))"` for each of the 6 locale files to confirm valid JSON. All 6 files must parse without error and contain map.seeMore, map.noLocations, location.backToMap, location.noImages, location.notFound.</verify>
  <done>All 6 locale files contain the 5 new keys and remain valid JSON. No duplicate keys.</done>
</task>

</tasks>

<verification>
- `pnpm tsc --noEmit` passes
- `grep -r "unsplash" src/` returns zero results
- `grep "projectsData" src/components/figma/ProjectsMap.tsx` returns zero results
- `grep -n "Powrót\|Brak zdjęć\|Lokalizacja nie" src/routes/locations.\$slug.tsx` returns zero results
- All 6 locale files are valid JSON with map.seeMore, map.noLocations, location.backToMap, location.noImages, location.notFound keys
- `grep -n "locations" src/routeTree.gen.ts` includes the locations/$slug route entry
- Map at / shows pins from CMS data; clicking a pin shows minimal popup with "See more" link
- Sidebar cards navigate to /locations/[slug]
- /locations/dabrowa loads with correct content, carousel controls present when multiple images
- Back-to-map button on location page works
</verification>

<success_criteria>
CMS-02: Image carousel exists on location pages with prev/next navigation.
CMS-03: Hardcoded projectsData removed; all data from Keystatic via getLocations().
BRAND-02: No Unsplash URLs in source code.
Location pages at /locations/[slug] are fully functional.
All location page strings are i18n-translated across all 6 languages.
routeTree.gen.ts updated with the new locations/$slug route.
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-polish/02-04-SUMMARY.md`
</output>
